<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1565c0" />
  <title>Control de Bomba </title>

  <style>
    /* ---- Material-like base ---- */
    :root{
      --primary: #1565c0;
      --primary-600: #0d47a1;
      --bg: #f4f6f8;
      --card: #ffffff;
      --muted: #6b7280;
      --success: #2e7d32;
      --danger: #c62828;
      --radius: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Roboto", "Arial", sans-serif;
      background: var(--bg);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
    }
    .container{
      max-width:600px;
      margin:0 auto;
    }
    header{
      text-align:center;
      margin-bottom:18px;
    }
    h1{
      margin:8px 0;
      color:var(--primary-600);
      font-size:22px;
    }

    /* Card */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 6px 18px rgba(17,24,39,0.06);
      margin-bottom:16px;
    }

    label.small { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }

    input[type="text"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6e9ee;
      font-size:15px;
      outline:none;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .row.space{justify-content:space-between}

    button.btn{
      width:100%;
      background:var(--primary);
      color:white;
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 6px 12px rgba(21,101,192,0.18);
    }
    button.btn.secondary{
      background:#fff;
      color:var(--primary-600);
      border:1px solid #e6e9ee;
      box-shadow:none;
    }
    .muted{ color: var(--muted); font-size:14px; }

    /* Progress bars */
    .barWrap{ margin:12px 0; }
    .barLabel{ display:flex; justify-content:space-between; font-weight:500; margin-bottom:6px; }
    .progress {
      height:18px;
      border-radius:10px;
      background: #e9eef6;
      overflow:hidden;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.03);
    }
    .progress > .fill{
      height:100%;
      background: linear-gradient(90deg,var(--primary), #42a5f5);
      width:0%;
      display:block;
      transition: width 450ms ease;
    }
    .percentSmall{ font-size:13px; color:var(--muted); margin-top:6px; }

    /* status badges */
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px; }
    .badge.ok{ background:#e8f5e9; color:var(--success); border:1px solid rgba(46,125,50,0.12); }
    .badge.off{ background:#fff3f3; color:var(--danger); border:1px solid rgba(198,40,40,0.12); }

    /* switches material */
    .switch {
      position: relative;
      width:56px;
      height:34px;
      border-radius:20px;
      background:#e6e9ee;
      transition: background .2s;
      cursor:pointer;
      display:inline-block;
    }
    .switch.disabled{ opacity:0.45; cursor:not-allowed; }
    .thumb {
      position:absolute;
      top:4px;
      left:4px;
      width:26px;
      height:26px;
      border-radius:50%;
      background:white;
      box-shadow: 0 3px 8px rgba(17,24,39,0.12);
      transition: left .18s, background .18s;
    }
    .switch.on{ background: linear-gradient(90deg,var(--primary), #42a5f5); }
    .switch.on .thumb { left:26px; }

    /* layout controls */
    .controlRow {display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px;}
    .controlTitle {font-weight:600;}

    /* response text */
    pre.jsonBox{
      background:#fff;
      padding:12px;
      border-radius:10px;
      border:1px solid #eef2f7;
      overflow:auto;
      font-size:13px;
      color:#111827;
    }

    /* responsive */
    @media (max-width:520px){
      body{ padding:16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Control de Bomba </h1>
      <div class="muted">Interfaz Material • Conecta a tu ESP32</div>
    </header>

    <!-- IP Card -->
    <div class="card">
      <label class="small">IP del ESP32</label>
      <div class="row">
        <input id="ip" type="text" placeholder="ej: 192.168.1.45" />
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="btnActualizar" class="btn">Actualizar</button>
        <button id="btnGuardar" class="btn secondary">Guardar IP</button>
      </div>
    </div>

    <!-- Estado Card -->
    <div class="card">
      <div class="row space">
        <div>
          <div style="font-weight:700">Estado del Sistema</div>
          <div class="muted" style="margin-top:6px">Niveles medidos por sensores</div>
        </div>
        <div id="conStatus" class="badge off">Desconectado</div>
      </div>

      <!-- Tanque -->
      <div class="barWrap">
        <div class="barLabel"><div>Tanque</div><div id="tanquePct">-- %</div></div>
        <div class="progress"><span id="tanqueFill" class="fill"></span></div>
        <div class="percentSmall" id="tanqueInfo">Altura: -- cm</div>
      </div>

      <!-- Pozo -->
      <div class="barWrap">
        <div class="barLabel"><div>Pozo</div><div id="pozoPct">-- %</div></div>
        <div class="progress"><span id="pozoFill" class="fill"></span></div>
        <div class="percentSmall" id="pozoInfo">Altura: -- cm</div>
      </div>
    </div>

    <!-- Controles Card -->
    <div class="card">
      <div style="font-weight:700; margin-bottom:10px">Controles</div>

      <!-- Modo -->
      <div class="controlRow">
        <div>
          <div class="controlTitle">Modo</div>
          <div class="muted">Automático / Manual</div>
        </div>
        <div style="text-align:right;">
          <div id="switchModo" class="switch" role="switch" aria-checked="true"><span class="thumb"></span></div>
        </div>
      </div>

      <!-- Bomba -->
      <div class="controlRow" style="margin-top:18px;">
        <div>
          <div class="controlTitle">Bomba</div>
          <div class="muted">Encendido / Apagado (solo en Manual)</div>
        </div>
        <div style="text-align:right;">
          <div id="switchBomba" class="switch disabled" role="switch" aria-checked="false"><span class="thumb"></span></div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="muted">Última actualización: <span id="lastUpdate">—</span></div>
    </div>

    <!-- Info JSON (opcional) -->
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px">Resumen</div>
      <pre id="jsonBox" class="jsonBox">Sin datos.</pre>
    </div>

  </div>

  <script>
    // ---------- util ----------
    function qs(id){ return document.getElementById(id); }
    const ipInput = qs('ip');
    const btnActualizar = qs('btnActualizar');
    const btnGuardar = qs('btnGuardar');

    const tanquePct = qs('tanquePct');
    const pozoPct = qs('pozoPct');
    const tanqueFill = qs('tanqueFill');
    const pozoFill = qs('pozoFill');
    const tanqueInfo = qs('tanqueInfo');
    const pozoInfo = qs('pozoInfo');
    const conStatus = qs('conStatus');
    const jsonBox = qs('jsonBox');
    const lastUpdate = qs('lastUpdate');

    const switchModo = qs('switchModo');
    const switchBomba = qs('switchBomba');

    // estado local
    let estado = {
      nivelTanque: 0,
      nivelPozo: 0,
      modoAutomatico: true,
      bombaOn: false,
      conectadoPozo: false
    };

    // guardar IP
    function guardarIP(){
      const v = ipInput.value.trim();
      if(!v){ alert('Escribe la IP del ESP32'); return; }
      localStorage.setItem('esp32_ip', v);
      alert('IP guardada');
    }
    // cargar IP
    function cargarIP(){
      const v = localStorage.getItem('esp32_ip');
      if(v) ipInput.value = v;
    }

    // actualizar UI desde estado
    function actualizarUI(){
      tanquePct.innerText = estado.nivelTanque + ' %';
      pozoPct.innerText = estado.nivelPozo + ' %';
      tanqueFill.style.width = Math.max(0, Math.min(100, estado.nivelTanque)) + '%';
      pozoFill.style.width = Math.max(0, Math.min(100, estado.nivelPozo)) + '%';
      tanqueInfo.innerText = 'Nivel tanque: ' + estado.nivelTanque + '%';
      pozoInfo.innerText = 'Nivel pozo: ' + estado.nivelPozo + '%';

      // badge
      if(estado.conectadoPozo){
        conStatus.innerText = 'Pozo: OK';
        conStatus.className = 'badge ok';
      } else {
        conStatus.innerText = 'Pozo: Desconectado';
        conStatus.className = 'badge off';
      }

      // switches
      setSwitch(switchModo, !estado.modoAutomatico); // on = manual visually? We'll map: on = manual (switch on means manual OFF automatic)
      // But user wanted Material with ON means Automatic? To keep clarity we map switch: ON = Manual (so user toggles)
      // show pump switch state
      setSwitchVisual(switchBomba, estado.bombaOn);
      // enable pump only in manual
      if(estado.modoAutomatico){
        switchBomba.classList.add('disabled');
        switchBomba.dataset.disabled = '1';
      } else {
        switchBomba.classList.remove('disabled');
        switchBomba.dataset.disabled = '0';
      }

      jsonBox.innerText = JSON.stringify(estado, null, 2);
      lastUpdate.innerText = new Date().toLocaleString();
    }

    // helper to set visual (thumb position)
    function setSwitchVisual(el, isOn){
      if(isOn) el.classList.add('on'); else el.classList.remove('on');
      el.setAttribute('aria-checked', isOn ? 'true' : 'false');
    }

    // prefer intuitive mapping: switchModo ON = MANUAL, OFF = AUTOMATICO
    function setSwitch(el, isOn){
      setSwitchVisual(el, isOn);
    }

    // ---------- networking ----------
    function baseUrl(){
      const ip = ipInput.value.trim();
      if(!ip) return null;
      // ensure no protocol or slash at end
      return 'http://' + ip;
    }

    async function fetchStatus(){
      const base = baseUrl();
      if(!base){ alert('Ingresa la IP del ESP32'); return; }
      try{
        const r = await fetch(base + '/status', { method:'GET' });
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        // expected keys: nivelTanque, nivelPozo, modoAutomatico, bombaOn, conectadoPozo
        estado.nivelTanque = ('nivelTanque' in j) ? j.nivelTanque : estado.nivelTanque;
        estado.nivelPozo = ('nivelPozo' in j) ? j.nivelPozo : estado.nivelPozo;
        estado.modoAutomatico = ('modoAutomatico' in j) ? j.modoAutomatico : estado.modoAutomatico;
        estado.bombaOn = ('bombaOn' in j) ? j.bombaOn : estado.bombaOn;
        estado.conectadoPozo = ('conectadoPozo' in j) ? j.conectadoPozo : estado.conectadoPozo;
        actualizarUI();
      } catch(err){
        console.error(err);
        alert('Error al conectar con ESP32: ' + err.message);
      }
    }

    // send command { action: 'encender' | 'apagar' | 'manual' | 'automatico' }
    async function sendCommand(action){
      const base = baseUrl();
      if(!base){ alert('Ingresa la IP del ESP32'); return; }
      try{
        const r = await fetch(base + '/command', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: action })
        });
        const text = await r.text();
        // try parse JSON
        try{
          const j = JSON.parse(text);
          // if error in response, show it
          if(!r.ok){
            alert('Error: ' + (j.error || text));
            return false;
          }
        } catch(e){
          // not JSON, ignore
        }
        // refresh local status (manual)
        await fetchStatus();
        return true;
      } catch(err){
        alert('Error enviando comando: ' + err.message);
        return false;
      }
    }

    // ---------- switch events ----------
    // Modo: ON = MANUAL, OFF = AUTOMATICO
    switchModo.addEventListener('click', async function(){
      // visual flip immediately for responsiveness
      const willBeManual = ! (switchModo.classList.contains('on'));
      setSwitchVisual(switchModo, willBeManual);

      // send command
      const action = willBeManual ? 'manual' : 'automatico';
      const ok = await sendCommand(action);
      if(!ok){
        // revert visual if failed
        setSwitchVisual(switchModo, !willBeManual);
      } else {
        // update local flag
        estado.modoAutomatico = !willBeManual;
        // update pump switch enabled state
        if(estado.modoAutomatico) {
          switchBomba.classList.add('disabled');
        } else {
          switchBomba.classList.remove('disabled');
        }
        actualizarUI();
      }
    });

    // Bomba: only allowed in manual
    switchBomba.addEventListener('click', async function(){
      // if disabled, do nothing
      if(switchBomba.dataset.disabled === '1') return;
      const willBeOn = ! switchBomba.classList.contains('on'); // toggle
      // If trying to turn ON, validate connectedPozo and nivelPozo>20
      if(willBeOn){
        if(!estado.conectadoPozo){
          alert('No hay conexión con nodo Pozo. No se puede encender.');
          return;
        }
        if(estado.nivelPozo <= 20){
          alert('Nivel del pozo insuficiente (' + estado.nivelPozo + '%). No se puede encender.');
          return;
        }
      }
      // visual immediate
      setSwitchVisual(switchBomba, willBeOn);
      // send command
      const action = willBeOn ? 'encender' : 'apagar';
      const ok = await sendCommand(action);
      if(!ok){
        // revert if failed
        setSwitchVisual(switchBomba, !willBeOn);
      } else {
        estado.bombaOn = willBeOn;
        actualizarUI();
      }
    });

    // ---------- buttons ----------
    btnActualizar.addEventListener('click', function(){ fetchStatus(); });
    btnGuardar.addEventListener('click', function(){ guardarIP(); });

    // ---------- init ----------
    (function init(){
      cargarIP();
      // fetch once on load automatically
      if(ipInput.value.trim()) {
        fetchStatus().catch(()=>{});
      }
      // initialize visuals
      actualizarUI();
    })();

  </script>
</body>
</html>

